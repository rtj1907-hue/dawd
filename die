local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function CreateHL(char)
    if not char or char:FindFirstChild("Direct_HL") then return end
    
    local hl = Instance.new("Highlight")
    hl.Name = "Direct_HL"
    hl.FillColor = Color3.fromRGB(255, 0, 0)
    hl.OutlineColor = Color3.fromRGB(255, 255, 255)
    hl.FillTransparency = 0.2
    hl.Parent = char

    local head = char:FindFirstChild("Head")
    if head then
        local bg = Instance.new("BillboardGui", head)
        bg.Name = "Direct_Tag"
        bg.Size = UDim2.new(0, 160, 0, 50)
        bg.AlwaysOnTop = true
        bg.ExtentsOffset = Vector3.new(0, 3.5, 0)
        local tl = Instance.new("TextLabel", bg)
        tl.Size = UDim2.new(1, 0, 1, 0)
        tl.BackgroundTransparency = 1
        tl.Text = "ğŸš¨ æ­»äº¡åæ“Š ğŸš¨"
        tl.TextColor3 = Color3.fromRGB(255, 0, 0)
        tl.TextStrokeTransparency = 0
        tl.TextScaled = true
        tl.Font = Enum.Font.LuckiestGuy
    end

    task.spawn(function()
        while char and char:FindFirstChild("Direct_HL") do
            task.wait(0.2)
            -- åªè¦ Counter ç‰©ä»¶æ¶ˆå¤±ï¼Œå°±ç«‹åˆ»é—œé–‰é«˜äº®
            if not char:FindFirstChild("Counter") then
                if hl then hl:Destroy() end
                if head and head:FindFirstChild("Direct_Tag") then head.Direct_Tag:Destroy() end
                break
            end
        end
    end)
end

local function ScanForDeath(p)
    local char = p.Character
    if not char then return end

    -- 1. æª¢æŸ¥æ˜¯å¦æœ‰ Counter ç‰©ä»¶
    local counterObj = char:FindFirstChild("Counter")
    if counterObj then
        -- 2. ã€æ ¸å¿ƒæ’é™¤é‚è¼¯ã€‘
        -- æ’é™¤å¸¸è¦‹æœƒèª¤å°çš„æŠ€èƒ½åç¨± (å¦‚æœæ˜¯æ¨äººæˆ–éŠ€ç‰™çš„åæ“Šå‰‡è·³é)
        if counterObj.Name:find("Shove") or char:FindFirstChild("FlowingWater") then
            return 
        end
        
        -- 3. æ’é™¤ç‰¹å®šè§’è‰² (å¦‚æœä½ çŸ¥é“å°æ‰‹æ˜¯éŠ€ç‰™æˆ–æƒ¡ç‹¼ï¼Œå°±ä¸äº®ç‡ˆ)
        -- TSB è£¡éŠ€ç‰™é€šå¸¸æœƒæœ‰ "Silver" å­—æ¨£ç‰©ä»¶ï¼Œæƒ¡ç‹¼æœ‰ "Hunter" æˆ– "Garou"
        if char:FindFirstChild("Hunter") or char:FindFirstChild("WaterStream") then
            return 
        end

        -- 4. å‰©ä¸‹ç¬¦åˆæ¢ä»¶çš„ï¼Œæ¥µå¤§æ©Ÿç‡å°±æ˜¯ç¦ç‰çš„æ­»æ‹³
        CreateHL(char)
    end
end

task.spawn(function()
    while true do
        task.wait(0.1) -- å¿«é€Ÿæƒæ
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character then
                pcall(function() ScanForDeath(p) end)
            end
        end
    end
end)
